# Фортран

## Программа
```fortran
program programName
    ! комментарий
end program programName
```

## Переменные

| Тип              |      Байт       |            Описание             |
| ---------------- | :-------------: | :-----------------------------: |
| integer          | 1, 2, 4*, 8, 16 |              целое              |
| real             |  4*, 8, 10, 16  |         действительное          |
| double precision |  4, 8*, 10, 16  | действительное двойной точности |
| complex          |  4*, 8, 10, 16  |           комплексное           |
| character        |      1, 4*      |             символ              |
| logical          | 1, 2, 4*, 8, 16 |       .TRUE. или .FALSE.        |

\* размер по-умолчанию

Размер изменяется параметром `kind`.
```fortran
integer(kind = 1) :: byte
integer(kind = 2) :: short
integer(kind = 4) :: long
integer(kind = 8) :: veryLong
integer(kind = 16) :: veryVeryLong
```

### Implicit none
По умолчанию в Фортране все переменные объявлены. Если имя переменной начинается с букв i, j, k, l, m, n —— она считается `integer`, иначе `real`.

Такое неявное объявление может приводить к сложнонаходимым ошибкам, поэтому рекомендуется отключить эту функцию с помощью `implicit none`.

### Литералы

```fortran
1           ! integer(kind = 4)
-256        ! integer(kind = 4)
400_16      ! integer(kind = 16)

B"10101"    ! integer в бинарном виде
O"8888"     ! integer в восьмеричном виде
Z"FFFF"     ! integer в шестнадцатеричном виде

2.718       ! real
.0001       ! real (можно без целой части)
1.          ! real (или без дробной части)
3.14E-4     ! real(kind = 4)
3.14D-4     ! real(kind = 8)
3.14Q-4     ! real(kind = 16)
1.4_16      ! real(kind = 16)

(1, 2)          ! complex(kind = 4)
(1.0, 2.0)      ! complex(kind = 4)
(-3.d13, 6._8)  ! complex(kind = 8)

.true.      ! logical
.false.     ! logical

"String"            ! character
'Another string'    ! character
```

### Константы
Для объявления неизменяемых величин используется ключевое слово `parameter`.
```fortran
real, parameter :: pi = 3.141592653589793238
```

## Массивы
### Статические массивы
```fortran
real :: array1(3)                  ! одномерный массив длиной 10
real, dimension = 3 :: array1      ! аналогично предыдущему

real :: array2(3, 3)                ! двумерный массив 10х10
real, dimension = 3, 3 :: array2    ! аналогично предыдущему

array1 = [1, 2, 3]                  ! заполнение массива
array1 = [(i, i = 1, 3)]            ! неявный цикл для заполнения
array1(:) = 0                       ! все элементы == 0
```

### Динамические массивы

Используются когда размер массива не известен на момент написания кода.

```fortran
real, allocatable :: array1(:)      ! одномерный динамический массив
real, allocatable :: array2(:, :)   ! двумерный динамический массив 

! выделение памяти
! elements, columns, rows —— integer
allocate(array1(elements))
allocate(array2(columns, rows))

! использовать как обычный массив
array1 = [(i, i = 1, elements)]

! освобождение памяти
deallocate(array1)
deallocate(array2)
```

### Срезы

Для получения доступа к части массива используются срезы.

Шаг по-умолчанию равен 1.

```fortran
array([lower]:[upper][:step])   ! общий синтаксис

array(1:3)      ! элементы 1, 2, 3
array(1:5:2)    ! элементы 1, 3, 5
array(:3)       ! элементы 1, 2, 3
array(1:)       ! элементы 1, 2, ... до конца
```

### Строки
Строка это массив символов. Может быть как статической, так и динамической.

```fortran
character (len = 11) :: string
string = “Some string”

character (len= :), allocatable :: allocatableString
allocate(allocatableString(11))
allocatableString = “Some string”
```

`len(string)` —— длина строки

### Преобразования типов

int()
real()
dble()
cmplx(im, re)


## Операции

### Арифметические операции

| Оператор |       Описание       |
| :------: | :------------------: |
|   `+`    |       сложение       |
|   `-`    |      вычитание       |
|   `*`    |      умножение       |
|   `/`    |       деление        |
|   `**`   | возведение в степень |

### Операции сравнения

| Оператор | Альтернатива |     Описание     |
| :------: | :----------: | :--------------: |
|   `==`   |    `.eq.`    |    равенство     |
|   `/=`   |    `.ne.`    |   неравенство    |
|   `>`    |    `.gt.`    |      больше      |
|   `<`    |    `.lt.`    |      меньше      |
|   `>=`   |    `.ge.`    | больше или равно |
|   `<=`   |    `.le.`    | меньше или равно |

### Булевы операторы

| Оператор |      Описание      |
| :------: | :----------------: |
| `.not.`  |     отрицание      |
| `.and.`  |     конъюнкция     |
|  `.or.`  |     дизъюнкция     |
| `.eqv.`  |  эквивалентность   |
| `.neqv.` | не эквивалентность |

### Строковый оператор

| Оператор |   Описание   |
| :------: | :----------: |
|   `//`   | конкатенация |

## Условия

### Простое условие
```fortran
if (condition) then      
   ! действия  
end if

! если действие одно
if (condition) then statement
```

### Условие и иначе

```fortran
if (condition) then      
   ! действия 
else
    ! действия 
end if
```

### Множественное условие

```fortran
if (condition) then
   ! действия
elseif (condition2) then
    ! действия
elseif (condition3) then
    ! действия 
else
    ! действия 
end if
```

### Выбор

```fortran
select case (expression) 
    case (variant1)
        ! действия          
    
    case (variant2)
        ! действия

    case (variant3)
        ! действия 

    case default          
        ! действия если не подошли все варианты

end select
```

Возможны диапазоны `case (from:to)`.

## Циклы

### Do (for)

```fortran
do i = from, to [,step]    
    ! действия 
end do
```

### Do while

```fortran
do while (condition) 
    ! действия 
end do
```

### Бесконечный цикл

```fortran
do
    ! действия 
end do
```

### Метки циклов

Для удобства контроля циклам можно присваивать метки.

```fortran
mark: do i = from, to [,step]    
    ! действия 
end do mark
```

### Управление циклами

`exit mark` —— завершает выполнение цикла mark

`cycle mark` —— завершает выполнение текущей итерации цикла mark

## Работа с файлами

Файл по-умолчанию `*` —— ввод/вывод в терминал.  

```fortran
read(*, format) i                    ! чтение переменной или массива
write(*, format) "Hello, World!"     ! вывод строки
```

### Открытие и закрытие файла

Открытие файла `filename` и связывание с идентификатором `fileID`.

```fortran
integer :: fileID = 0

open(unit = fileID, status, file = "filename")
close(fileID)
```

#### Статус
|   Метка   |                         Значение                         |
| :-------: | :------------------------------------------------------: |
|   `OLD`   | открыть существующий файл   Если файла нет, будет ошибка |
|   `NEW`   |                    создать новый файл                    |
| `SCRATCH` | создать новый файл, который после закрытия будет удалён  |


### Форматирование

При чтении и записи переменных возможна настройка формата.  
Общий вид строки формата: `"([множитель][метка формата][размер])"`.

| Метка |                     Описание                      |          Формат размера           |  Пример   |
| :---: | :-----------------------------------------------: | :-------------------------------: | :-------: |
|  `i`  |                    целое число                    | `[ширина].[число выводимых цифр]` |   `10`    |
|  `f`  |             число с плавающей точкой              |  `[ширина].[цифр после запятой]`  |  `1.00`   |
|  `e`  | число с плавающей запятой в экспоненциальном виде |  `[ширина].[цифр после запятой]`  | `0.1e+01` |
| `es`  |     число с плавающей запятой в научном виде      |  `[ширина].[цифр после запятой]`  | `1.0e+00` |
|  `a`  |                      строка                       |           `[символов]`            | `символы` |
|  `x`  |                      пробел                       |        `[число пробелов]`         |   `   `   |
|  `/`  |                  перевод строки                   |                нет                |           |

Для экспоненциальной и научной форм `[ширина] >= [цифр после запятой] + 7` (знак мантиссы, целая часть, точка, е, знак порядка, 2 цифры порядка).

Вывод с разным форматированием можно сочетать через запятую:

```fortran
write(*, "(i4, f2.4)") i, r
```

## Процедуры

Подпрограмма не возвращает значение, но может изменять переданные ей переменные. 

Функция возвращает значение. Но также может изменять переданные ей переменные.

В начале процедуры должно быть описание всех входящих и выходящих переменных.  

### Метки аргументов

|      Метка      |               Описание                |
| :-------------: | :-----------------------------------: |
|  `intent(in)`   |        вход, только для чтения        |
|  `intent(out)`  |    выход, может быть перезаписана     |
| `intent(inout)` | вход и выход, может быть перезаписана |

### Подпрограммы

```fortran
subroutine sub(arg1, arg2, arg3)    
    <type>, intent(in) :: arg1
    <type>, intent(inout) :: arg2
    <type>, intent(out) :: arg3

    ! код подпрограммы

end subroutine sub
```

### Функции

```fortran
function func(arg1, arg2) result (res)
    <type>, intent(in) :: arg1
    <type>, intent(in) :: arg2
    <type>, intent(out) :: res

    ! код функции
    res = ...

end function func
```

Рекурсивные функции дополнительно помечаются `recursive function`.

## Встроенные функции

### Матричные функции

|              Функция              |            Описание             |
| :-------------------------------: | :-----------------------------: |
| `dot_product(vector_a, vector_b)` | скалярное произведение векторов |
|   `matmul(matrix_a, matrix_b)`    |     матричное произведение      |
|    `maxval(array, dim, mask)`     |            максимум             |
|    `minval(array, dim, mask)`     |             минимум             |
|    `product(array, dim, mask)`    |     произведение элементов      |
|      `sum(array, dim, mask)`      |         сумма элементов         |


```fortran
integer :: val
integer :: u(3), v(3), w(3)
integer :: A(3, 3), B(3, 3), C(3, 3)

w = dot_product(u, v)
C = matmul(A, B)

val = maxval(A, 1)          ! максимум по столбцам
val = minval(A)             ! минимум по всей матрице
val = product(A, A > 3)     ! произведение элементов больше 3
val = sum(A, 1, A < 3)      ! произведение по столбцам элементов меньше 3
```

### Математические функции

|  Функция   |            Описание             |
| :--------: | :-----------------------------: |
|  `abs(a)`  |             модуль              |
| `aimag(z)` | мнимая часть комплексного числа |
| `conjg(z)` | сопряжённое комплексному числу  |
